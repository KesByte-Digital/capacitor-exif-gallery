{"version":3,"file":"ImageGalleryImpl.js","sourceRoot":"","sources":["../../src/ImageGalleryImpl.ts"],"names":[],"mappings":"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","sourcesContent":["import { FilterValidator } from './FilterValidator';\nimport { PluginState } from './PluginState';\nimport { TranslationLoader } from './TranslationLoader';\nimport type { ImageGalleryPlugin, InitConfig, PickOptions, PickResult } from './definitions';\nimport { InitializationRequiredError, PickerInProgressError, FilterError } from './errors';\n\n/**\n * TypeScript implementation of ImageGalleryPlugin.\n *\n * Handles:\n * - Translation loading and merging\n * - Plugin state management\n * - Validation\n * - Native bridge communication\n *\n * @internal\n */\nexport class ImageGalleryImpl implements ImageGalleryPlugin {\n  /**\n   * Native plugin instance for Capacitor Bridge communication.\n   * @private\n   */\n  private nativePlugin: ImageGalleryPlugin;\n\n  /**\n   * Create ImageGalleryImpl instance with native bridge dependency.\n   *\n   * @param nativePlugin - Native plugin instance from Capacitor Bridge\n   */\n  constructor(nativePlugin: ImageGalleryPlugin) {\n    this.nativePlugin = nativePlugin;\n  }\n  /**\n   * Initialize the plugin with optional configuration.\n   *\n   * This method performs the following steps:\n   * 1. Language Detection: Detects system language via navigator.language\n   *    (e.g., 'de-DE' → 'de'), or uses explicit config.locale\n   * 2. Default Loading: Loads appropriate translation file (en.json, de.json, fr.json, es.json)\n   * 3. Fallback: Falls back to English if system language is not supported\n   * 4. Merging: Merges config.customTexts on top of default translations\n   * 5. Validation: Validates locale and customTexts keys\n   * 6. Native Bridge: Passes translations and permissions to native layers\n   * 7. State Update: Stores merged translations in PluginState singleton (only after native success)\n   *\n   * All InitConfig properties are optional:\n   * - locale?: 'en' | 'de' | 'fr' | 'es' - Explicit language override\n   * - customTexts?: Partial<TranslationSet> - Custom text overrides\n   * - requestPermissionsUpfront?: boolean - Request Photo Library permissions immediately\n   *\n   * Permission Behavior:\n   * - If requestPermissionsUpfront is true, native layers request Photo Library access\n   * - The promise resolves regardless of whether permission was granted or denied\n   * - If permission is denied, pick() will request it again when called\n   * - Location permissions are NEVER requested upfront (only when filter uses location)\n   * - Check logs for permission grant/deny status on Android\n   *\n   * Placeholder Syntax:\n   * - {count}: Current selection count (e.g., \"3\")\n   * - {total}: Total available items (e.g., \"24\")\n   * - Example: \"{count} of {total} selected\" → \"3 of 24 selected\"\n   *\n   * @param config - Optional initialization configuration\n   * @returns Promise that resolves when initialization is complete\n   * @throws {Error} If locale is invalid (not 'en' | 'de' | 'fr' | 'es')\n   * @throws {Error} If customTexts contains invalid keys\n   * @throws {Error} If native initialization fails\n   *\n   * @example\n   * ```typescript\n   * // System language detection (navigator.language)\n   * await ImageGallery.initialize();\n   *\n   * // Explicit locale\n   * await ImageGallery.initialize({ locale: 'de' });\n   *\n   * // Custom text overrides with system language detection\n   * await ImageGallery.initialize({\n   *   customTexts: {\n   *     galleryTitle: 'Pick Your Photos',\n   *     confirmButton: 'Done',\n   *   },\n   * });\n   *\n   * // Explicit locale + custom overrides\n   * await ImageGallery.initialize({\n   *   locale: 'en',\n   *   customTexts: {\n   *     galleryTitle: 'Choose Images',\n   *   },\n   * });\n   *\n   * // Request permissions upfront\n   * await ImageGallery.initialize({\n   *   requestPermissionsUpfront: true,\n   * });\n   * ```\n   */\n  async initialize(config?: InitConfig): Promise<void> {\n    const state = PluginState.getInstance();\n\n    // Load and merge translations\n    const mergedTranslations = TranslationLoader.loadTranslations(config?.locale, config?.customTexts);\n\n    const requestPermissionsUpfront = config?.requestPermissionsUpfront ?? false;\n\n    // Call native layer FIRST (before updating state)\n    // If native call fails, state remains unchanged\n    await this.nativePlugin.initialize({\n      locale: undefined, // Not needed, we pass full translations\n      customTexts: mergedTranslations, // Full merged TranslationSet\n      requestPermissionsUpfront,\n    });\n\n    // Only update state after native confirmation\n    state.setRequestPermissionsUpfront(requestPermissionsUpfront);\n    state.setMergedTranslations(mergedTranslations);\n    state.setInitialized(true);\n  }\n\n  /**\n   * Open native gallery with optional filter configuration.\n   *\n   * This method performs the following steps:\n   * 1. Initialization Check: Verifies initialize() was called\n   * 2. Concurrent Check: Prevents opening multiple pickers simultaneously\n   * 3. Filter Validation: Validates all filter parameters\n   * 4. Default Values: Applies defaults for fallbackThreshold and allowManualAdjustment\n   * 5. Native Bridge: Calls native layer with filter configuration\n   * 6. Result Handling: Returns PickResult with selected images\n   *\n   * Filter Options:\n   * - filter.location.polyline: Array of LatLng defining a path (min 2 points)\n   * - filter.location.coordinates: Array of LatLng for specific locations\n   * - filter.location.radius: Search radius in meters (default: 100, must be > 0)\n   * - filter.timeRange.start: Start date/time (must be before end)\n   * - filter.timeRange.end: End date/time (must be after start)\n   * - fallbackThreshold: Minimum images to show filter UI (default: 5)\n   * - allowManualAdjustment: Allow user to adjust filters (default: true)\n   *\n   * @param options - Optional picker configuration\n   * @returns Promise<PickResult> with selected images array and cancelled flag\n   * @throws {Error} 'initialization_required' if initialize() not called\n   * @throws {Error} 'picker_in_progress' if picker is already open\n   * @throws {Error} 'filter_error' if filter parameters are invalid\n   *\n   * @example\n   * ```typescript\n   * // Simple pick without filters\n   * const result = await ImageGallery.pick();\n   *\n   * // Location filter with coordinates\n   * const result = await ImageGallery.pick({\n   *   filter: {\n   *     location: {\n   *       coordinates: [{ lat: 48.8566, lng: 2.3522 }], // Paris\n   *       radius: 500 // 500 meters\n   *     }\n   *   }\n   * });\n   *\n   * // Time range filter\n   * const result = await ImageGallery.pick({\n   *   filter: {\n   *     timeRange: {\n   *       start: new Date('2024-01-01'),\n   *       end: new Date('2024-12-31')\n   *     }\n   *   }\n   * });\n   *\n   * // Combined filters with custom options\n   * const result = await ImageGallery.pick({\n   *   filter: {\n   *     location: {\n   *       polyline: [\n   *         { lat: 48.8566, lng: 2.3522 },\n   *         { lat: 48.8606, lng: 2.3376 }\n   *       ],\n   *       radius: 200\n   *     },\n   *     timeRange: {\n   *       start: new Date('2024-06-01'),\n   *       end: new Date('2024-06-30')\n   *     }\n   *   },\n   *   fallbackThreshold: 10,\n   *   allowManualAdjustment: false\n   * });\n   * ```\n   */\n  async pick(options?: PickOptions): Promise<PickResult> {\n    const state = PluginState.getInstance();\n\n    // 1. Verify plugin is initialized\n    if (!state.isInitialized()) {\n      throw new InitializationRequiredError();\n    }\n\n    // 2. Prevent concurrent picker operations (atomic check-and-set)\n    if (!state.trySetPickerInProgress()) {\n      throw new PickerInProgressError();\n    }\n\n    try {\n      // Picker is now marked as in progress (atomic operation above)\n\n      // 3. Validate filter configuration if provided\n      if (options?.filter) {\n        FilterValidator.validateFilterConfig(options.filter);\n      }\n\n      // 4. Apply default values and convert Date objects to timestamps\n      const pickOptions: any = {\n        fallbackThreshold: options?.fallbackThreshold ?? 5,\n        allowManualAdjustment: options?.allowManualAdjustment ?? true,\n        hasActiveFilters: this.hasActiveFilters(options), // Story 8.2: Detect active filters\n        distanceUnit: options?.distanceUnit ?? 'kilometers',\n        distanceStep: options?.distanceStep ?? 5,\n      };\n\n      // Convert filter configuration for native bridge\n      if (options?.filter) {\n        pickOptions.filter = {};\n\n        // Copy location filter as-is\n        if (options.filter.location) {\n          pickOptions.filter.location = options.filter.location;\n        }\n\n        // Convert Date objects to timestamps (milliseconds) for native bridge\n        if (options.filter.timeRange) {\n          pickOptions.filter.timeRange = {\n            start: options.filter.timeRange.start.getTime(),\n            end: options.filter.timeRange.end.getTime(),\n          };\n        }\n      }\n\n      // Validate fallbackThreshold\n      if (pickOptions.fallbackThreshold !== undefined) {\n        if (typeof pickOptions.fallbackThreshold !== 'number' || !isFinite(pickOptions.fallbackThreshold)) {\n          throw new FilterError('fallbackThreshold must be a finite number');\n        }\n        if (pickOptions.fallbackThreshold < 0) {\n          throw new FilterError('fallbackThreshold must be greater than or equal to 0');\n        }\n        // Prevent unreasonably large threshold\n        if (pickOptions.fallbackThreshold > 10000) {\n          throw new FilterError('fallbackThreshold must not exceed 10,000');\n        }\n      }\n\n      // Validate allowManualAdjustment\n      if (pickOptions.allowManualAdjustment !== undefined) {\n        if (typeof pickOptions.allowManualAdjustment !== 'boolean') {\n          throw new FilterError('allowManualAdjustment must be a boolean');\n        }\n      }\n\n      // Validate distanceUnit\n      if (pickOptions.distanceUnit !== undefined) {\n        const validUnits = ['kilometers', 'miles'];\n        if (!validUnits.includes(pickOptions.distanceUnit)) {\n          throw new FilterError(`distanceUnit must be one of: ${validUnits.join(', ')}`);\n        }\n      }\n\n      // Validate distanceStep\n      if (pickOptions.distanceStep !== undefined) {\n        if (typeof pickOptions.distanceStep !== 'number' || !isFinite(pickOptions.distanceStep)) {\n          throw new FilterError('distanceStep must be a finite number');\n        }\n        if (pickOptions.distanceStep < 1) {\n          throw new FilterError('distanceStep must be at least 1 km');\n        }\n        if (pickOptions.distanceStep > 25) {\n          throw new FilterError('distanceStep must not exceed 25 km');\n        }\n      }\n\n      // 5. Call native layer via Capacitor Bridge\n      const result = await this.nativePlugin.pick(pickOptions);\n\n      return result;\n    } finally {\n      // 6. Always clear picker in progress flag (success or error)\n      state.setPickerInProgress(false);\n    }\n  }\n\n  /**\n   * Detects if active filters are present in pick options.\n   *\n   * **Story 8.2:** Used to determine filter button visibility.\n   *\n   * Note: This is called AFTER FilterValidator.validateFilterConfig(),\n   * so encoded polyline strings have already been decoded to arrays.\n   *\n   * @param options - Pick options to check\n   * @returns true if location or time filters are present\n   */\n  private hasActiveFilters(options?: PickOptions): boolean {\n    if (!options?.filter) return false;\n\n    // Check for location filter (coordinates array or polyline)\n    // Note: polyline can be string OR array, but after validation it's always an array\n    const polyline = options.filter.location?.polyline;\n    const hasPolyline = Array.isArray(polyline)\n      ? polyline.length > 0\n      : typeof polyline === 'string'\n        ? polyline.trim().length > 0\n        : false;\n\n    const hasLocationFilter = !!(options.filter.location?.coordinates?.length || hasPolyline);\n\n    const hasTimeFilter = !!(options.filter.timeRange?.start && options.filter.timeRange.end);\n\n    return hasLocationFilter || hasTimeFilter;\n  }\n}\n"]}